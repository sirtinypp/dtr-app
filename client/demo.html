<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTR Premium Demo</title>
    <!-- React & Babel from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- CSS -->
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            --font-family: 'Inter', system-ui, sans-serif;
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow);
            padding: 2rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
        }

        input {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            padding: 12px;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }

        h2,
        h1,
        p {
            margin: 0 0 1rem 0;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [view, setView] = useState(token ? 'dashboard' : 'login');
            const [user, setUser] = useState(null);

            // Login State
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [msg, setMsg] = useState('');

            // Dashboard State
            const [logs, setLogs] = useState([]);

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch('http://localhost:3000/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setToken(data.token);
                        setUser(data.user);
                        setView('dashboard');
                        setMsg('');
                    } else {
                        setMsg(data.error);
                    }
                } catch (e) { setMsg('Network Error'); }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                if (!registerFaceBlob) {
                    setMsg("Please capture your face first!");
                    return;
                }

                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('full_name', 'New Staff'); // Hardcoded for demo simplicity
                formData.append('face_image', registerFaceBlob, 'face.jpg');

                try {
                    const res = await fetch('http://localhost:3000/api/auth/register', {
                        method: 'POST',
                        body: formData
                    });
                    if (res.ok) {
                        alert("Registration Complete! Please Login.");
                        setIsRegister(false);
                    } else {
                        const data = await res.json();
                        setMsg(data.error || 'Registration Failed');
                    }
                } catch (e) { setMsg('Network Error'); }
            };

            // Register State
            const [isRegister, setIsRegister] = useState(false);
            const [registerFaceBlob, setRegisterFaceBlob] = useState(null);

            const startRegisterCamera = async () => {
                setCameraError('');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    setVideoStream(stream);
                    setShowCamera(true);
                    setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100);
                } catch (e) { setCameraError("Camera blocked. (Check permissions)"); setUseMockCamera(true); }
            };

            const captureRegisterFace = async () => {
                let blob;
                if (!useMockCamera && videoRef.current) {
                    const ctx = canvasRef.current.getContext('2d');
                    ctx.drawImage(videoRef.current, 0, 0, 320, 240);
                    blob = await new Promise(r => canvasRef.current.toBlob(r, 'image/jpeg'));
                } else {
                    blob = new Blob(['mock'], { type: 'image/jpeg' });
                }
                setRegisterFaceBlob(blob);
                stopCamera();
            };



            // Camera State
            const [showCamera, setShowCamera] = useState(false);
            const [useMockCamera, setUseMockCamera] = useState(false);
            const [logType, setLogType] = useState(null);
            const [videoStream, setVideoStream] = useState(null);
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            const [cameraError, setCameraError] = useState('');
            const [scanning, setScanning] = useState(false);
            const [matchScore, setMatchScore] = useState(0);

            // Face API State
            const [modelsLoaded, setModelsLoaded] = useState(false);
            const [userDescriptor, setUserDescriptor] = useState(null);

            // Load Models
            useEffect(() => {
                const loadModels = async () => {
                    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                    try {
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                        ]);
                        setModelsLoaded(true);
                        console.log("FaceAPI Models Loaded");
                    } catch (e) { console.error("Model Load Failed", e); setCameraError("Failed to load AI Models"); }
                };
                loadModels();
            }, []);

            // Calculate User Descriptor on Login
            useEffect(() => {
                const processUserImage = async () => {
                    if (user && user.face_image && modelsLoaded) {
                        const img = document.createElement('img');
                        img.src = `http://localhost:3000/${user.face_image}`;
                        img.crossOrigin = 'anonymous';
                        img.onload = async () => {
                            const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                            if (detection) {
                                setUserDescriptor(detection.descriptor);
                                console.log("User Face Descriptor Computed");
                            } else {
                                console.warn("No face found in registered image");
                            }
                        };
                    }
                };
                processUserImage();
            }, [user, modelsLoaded]);

            const startCamera = async (type) => {
                setLogType(type);
                setShowCamera(true);
                setUseMockCamera(false);
                setCameraError('');
                setScanning(true);
                setMatchScore(0);

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    setCameraError("Browser API not supported.");
                    setUseMockCamera(true);
                    // Still scan in mock mode for demo
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        setVideoStream(stream);
                        setTimeout(() => {
                            if (videoRef.current) videoRef.current.srcObject = stream;
                        }, 100);
                    } catch (e) {
                        console.warn("Camera failed, using mock.", e);
                        setCameraError("Camera unavailable.");
                        setUseMockCamera(true);
                    }
                }
            };

            // Auto-Scan Effect (REAL)
            useEffect(() => {
                let interval;
                if (showCamera && scanning && modelsLoaded && videoRef.current && userDescriptor) {
                    interval = setInterval(async () => {
                        if (videoRef.current && !videoRef.current.paused && !videoRef.current.ended) {
                            // Detect Live Face
                            const detection = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

                            if (detection) {
                                // Compare
                                const distance = faceapi.euclideanDistance(userDescriptor, detection.descriptor);
                                // Distance < 0.6 is usually a match. 
                                // Map 0.6 -> 0 to 100%? 
                                // Let's say 0.0 is 100%, 0.6 is 50%. 
                                // Simple formula: Match% = (1 - distance) * 100.
                                // If distance is 0.4, Score = 60%.
                                // Wait, usually 0.4 is a GOOD match. 0.6 is threshold.
                                // Let's adjust: if distance > 0.6, score < 40%.
                                // Let's use: (1 - distance / 0.8) * 100 roughly?
                                // Standard: Distance 0.4 is strong match.

                                let score = Math.round((1 - distance) * 100);
                                if (score < 0) score = 0;

                                setMatchScore(score);

                                if (distance < 0.45) { // Strict threshold (approx 55-60% raw inverted distance, but safely under 0.6)
                                    // Actually if score > 55 with simple inversion.
                                    // Let's stick to the user's "80% closeness" request.
                                    // If we map (1-distance)*100.. then 0.2 distance = 80%. That's extremely strict.
                                    // Let's normalize. 0.6 distance = 0% match. 0.0 distance = 100% match.
                                    // Score = Math.max(0, (1 - (distance / 0.6)) * 100) ? 
                                    // If dist 0.3 -> 1 - 0.5 = 50%... logic hard.

                                    // FaceAPI suggests 0.6 as threshold.
                                    // Let's just use raw inverted for display and check distance for Trigger.
                                    // Trigger if distance < 0.4 (Very good match)

                                    if (distance < 0.4) {
                                        clearInterval(interval);
                                        setScanning(false);
                                        captureAndLog();
                                    }
                                }
                            } else {
                                setMatchScore(0);
                            }
                        }
                    }, 200); // Check every 200ms
                }
                return () => clearInterval(interval);
            }, [showCamera, scanning, modelsLoaded, userDescriptor]);

            const stopCamera = () => {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    setVideoStream(null);
                }
                setShowCamera(false);
                setUseMockCamera(false);
            };

            const captureAndLog = async () => {
                let imageBlob;
                if (!useMockCamera && videoRef.current) {
                    const context = canvasRef.current.getContext('2d');
                    context.drawImage(videoRef.current, 0, 0, 320, 240);
                    imageBlob = await new Promise(resolve => canvasRef.current.toBlob(resolve, 'image/jpeg'));
                } else {
                    // Generate Mock ID Image
                    const ctx = canvasRef.current.getContext('2d');
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(0, 0, 320, 240);
                    ctx.fillStyle = '#38bdf8';
                    ctx.beginPath();
                    ctx.arc(160, 100, 50, 0, 2 * Math.PI); // Head
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(160, 240, 100, Math.PI, 0); // Body
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.font = '20px Arial';
                    ctx.fillText('MOCK FACE ID', 90, 40);
                    ctx.fillStyle = '#4ade80';
                    ctx.fillText('VERIFIED âœ“', 110, 200);

                    imageBlob = await new Promise(resolve => canvasRef.current.toBlob(resolve, 'image/jpeg'));
                }

                // Upload
                const formData = new FormData();
                formData.append('snapshot', imageBlob, 'capture.jpg');
                formData.append('type', logType);
                formData.append('verification_score', 0.99); // Mocked AI score

                try {
                    const res = await fetch('http://localhost:3000/api/dtr/log', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (res.ok) {
                        alert(`Face Verified! Clocked ${logType} Successfully.`);
                        stopCamera();
                        fetchLogs();
                    }
                } catch (e) { alert('Error uploading log'); }
            };

            const fetchLogs = async () => {
                const res = await fetch('http://localhost:3000/api/dtr/my-logs', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) setLogs(await res.json());
            }

            useEffect(() => { if (view === 'dashboard') fetchLogs(); }, [view]);

            if (view === 'login') {
                return (
                    <div className="glass-panel" style={{ width: '350px', textAlign: 'center' }}>
                        <h2 style={{ background: 'linear-gradient(to right, var(--accent-primary), var(--accent-secondary))', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                            {isRegister ? 'Register Face ID' : 'DTR Login'}
                        </h2>
                        {msg && <p style={{ color: 'red' }}>{msg}</p>}

                        {!isRegister ? (
                            <form onSubmit={handleLogin}>
                                <input placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} />
                                <input placeholder="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} />
                                <button className="btn-primary">Login</button>
                                <p style={{ marginTop: '1rem', fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Try user: <b>admin</b> pass: <b>admin</b></p>
                                <p onClick={() => setIsRegister(true)} style={{ cursor: 'pointer', color: 'var(--accent-primary)', textDecoration: 'underline' }}>Create Account</p>
                            </form>
                        ) : (
                            <div>
                                <input placeholder="New Username" value={username} onChange={e => setUsername(e.target.value)} />
                                <input placeholder="New Password" type="password" value={password} onChange={e => setPassword(e.target.value)} />

                                {registerFaceBlob ? (
                                    <div style={{ color: '#4ade80', margin: '10px 0' }}>âœ“ Face Captured</div>
                                ) : (
                                    <div style={{ margin: '10px 0' }}>
                                        {!videoStream ? (
                                            <button type="button" onClick={startRegisterCamera} style={{ background: '#334155', color: 'white', border: 'none', padding: '8px', borderRadius: '8px', width: '100%' }}>ðŸ“· Open Camera</button>
                                        ) : (
                                            <div style={{ marginTop: '10px' }}>
                                                <video ref={videoRef} autoPlay playsInline width="100%" style={{ borderRadius: '8px' }}></video>
                                                <canvas ref={canvasRef} width="320" height="240" style={{ display: 'none' }}></canvas>
                                                <button type="button" onClick={captureRegisterFace} className="btn-primary" style={{ marginTop: '5px' }}>Capture</button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <button onClick={handleRegister} className="btn-primary" disabled={!registerFaceBlob}>Sign Up</button>
                                <p onClick={() => setIsRegister(false)} style={{ cursor: 'pointer', color: 'gray', fontSize: '0.8rem', marginTop: '10px' }}>Cancel</p>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div style={{ width: '100%', maxWidth: '800px' }}>
                    <div className="glass-panel" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h1>Hello, {user?.username || 'Staff'}</h1>
                        <button onClick={() => setView('login')} style={{ background: 'transparent', border: '1px solid var(--accent-secondary)', color: 'white', padding: '8px 16px', borderRadius: '8px' }}>Logout</button>
                    </div>

                    {!showCamera ? (
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '2rem' }}>
                            <button className="btn-primary" onClick={() => startCamera('IN')} style={{ fontSize: '1.5rem' }}>ðŸ“· Clock In</button>
                            <button className="btn-primary" onClick={() => startCamera('OUT')} style={{ fontSize: '1.5rem', background: 'transparent', border: '1px solid var(--accent-secondary)' }}>ðŸ“· Clock Out</button>
                        </div>
                    ) : (
                        <div className="glass-panel" style={{ marginBottom: '2rem', textAlign: 'center' }}>
                            <h3>{scanning ? 'Searching for Face...' : 'Verifying FaceID...'}</h3>

                            <div style={{ position: 'relative', display: 'inline-block', marginBottom: '1rem' }}>
                                {/* Live Camera Container */}
                                <div style={{
                                    borderRadius: '16px',
                                    overflow: 'hidden',
                                    border: `4px solid ${matchScore > 80 ? '#4ade80' : 'var(--accent-primary)'}`,
                                    width: '320px',
                                    height: '240px',
                                    position: 'relative',
                                    transition: 'border-color 0.3s ease'
                                }}>
                                    {!useMockCamera ? (
                                        <>
                                            <video ref={videoRef} autoPlay playsInline width="320" height="240" style={{ display: 'block' }}></video>
                                            <canvas ref={canvasRef} width="320" height="240" style={{ display: 'none' }}></canvas>
                                        </>
                                    ) : (
                                        <div style={{ width: '100%', height: '100%', background: '#1e293b', display: 'flex', alignItems: 'center', justifyContent: 'center', flexDirection: 'column', position: 'relative', padding: '1rem', boxSizing: 'border-box' }}>
                                            <div style={{ fontSize: '3rem', filter: 'grayscale(100%)', marginBottom: '10px' }}>ðŸ“·ðŸš«</div>
                                            <div style={{ color: '#f87171', fontWeight: 'bold', marginBottom: '5px' }}>Camera Unavailable</div>
                                            <button onClick={() => startCamera(logType)} style={{ background: 'var(--glass-border)', color: 'white', border: '1px solid var(--accent-primary)', padding: '5px 10px', borderRadius: '8px', cursor: 'pointer', fontSize: '0.8rem' }}>
                                                Retry
                                            </button>
                                        </div>
                                    )}

                                    {/* Scanning Overlay */}
                                    {scanning && (
                                        <div style={{
                                            position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',
                                            background: 'linear-gradient(to bottom, transparent, rgba(56, 189, 248, 0.2), transparent)',
                                            animation: 'scan 1.5s infinite linear',
                                            pointerEvents: 'none'
                                        }}></div>
                                    )}
                                </div>

                                {/* Match Score Indicator */}
                                {scanning && (
                                    <div style={{
                                        position: 'absolute', bottom: '10px', left: '50%', transform: 'translateX(-50%)',
                                        background: 'rgba(0,0,0,0.7)', padding: '4px 12px', borderRadius: '12px',
                                        color: matchScore > 55 ? '#4ade80' : 'white', fontWeight: 'bold', fontSize: '0.9rem'
                                    }}>
                                        {modelsLoaded ? (userDescriptor ? `Match: ${matchScore}%` : 'Loading User Face...') : 'Loading AI Models...'}
                                    </div>
                                )}
                            </div>

                            {/* Registered Face Preview */}
                            {user?.face_image && (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px', marginBottom: '1rem' }}>
                                    <img src={`http://localhost:3000/${user.face_image}`} style={{ width: '60px', borderRadius: '8px', border: '1px solid rgba(255,255,255,0.2)', opacity: 0.6 }} />
                                    <span style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Comparing to Reg. Face</span>
                                </div>
                            )}

                            <div>
                                <button onClick={stopCamera} style={{ background: 'transparent', color: 'var(--text-secondary)', border: '1px solid var(--glass-border)', padding: '8px 16px', borderRadius: '8px', cursor: 'pointer' }}>Cancel</button>
                            </div>
                        </div>
                    )}

                    <div className="glass-panel">
                        <h3>Recent Logs</h3>
                        {logs.map(l => (
                            <div key={l.id} style={{ padding: '1rem', borderBottom: '1px solid rgba(255,255,255,0.05)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <span style={{ color: l.type === 'IN' ? '#34d399' : '#ef4444', fontWeight: 'bold', marginRight: '10px' }}>{l.type}</span>
                                    <span>{new Date(l.timestamp).toLocaleTimeString()}</span>
                                </div>
                                {l.snapshot_image && <a href={`http://localhost:3000/${l.snapshot_image}`} target="_blank" style={{ color: 'var(--accent-primary)', fontSize: '0.9rem' }}>View Snapshot</a>}
                            </div>
                        ))}
                        {logs.length === 0 && <p>No logs yet.</p>}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>